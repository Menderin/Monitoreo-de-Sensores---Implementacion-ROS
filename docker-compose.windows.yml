# ==============================================================================
# docker-compose.windows.yml — Monitor de Microalgas UCN
# ==============================================================================
#
# SOLO para WSL2 + Docker Desktop en Windows.
# Usa bridge network en lugar de network_mode: host (que no funciona en Docker
# Desktop) y configura FastRTPS con unicast para que los dos contenedores se
# descubran sin multicast.
#
# Uso:
#   docker compose -f docker-compose.windows.yml up -d
#
# En Linux o WSL2 con Docker nativo, usar docker-compose.yml (network_mode: host).
# ==============================================================================

services:

  # ── 1. micro-ROS Agent ──────────────────────────────────────────────────────
  microros_agent:
    build:
      context: .
      dockerfile: docker/Dockerfile.ros
    image: microalgas/microros-agent:latest
    container_name: microros_agent
    networks:
      - ros_net
    ports:
      # Expone UDP 8888 al host Windows para recibir paquetes del ESP32.
      # El ESP32 debe apuntar a la IP de la interfaz WSL2 (eth0 dentro de WSL2).
      - "8888:8888/udp"
    command: >
      ros2 run micro_ros_agent micro_ros_agent
      udp4 --port 8888 -v4
    restart: unless-stopped
    env_file:
      - database/.env
    environment:
      RMW_IMPLEMENTATION: rmw_fastrtps_cpp
      # Perfil XML que desactiva multicast y usa unicast entre contenedores
      FASTRTPS_DEFAULT_PROFILES_FILE: /app/config/fastrtps_bridge.xml
    volumes:
      - ./config/fastrtps_bridge.xml:/app/config/fastrtps_bridge.xml:ro
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ── 2. Nodo ROS 2 → MongoDB ─────────────────────────────────────────────────
  ros_node:
    build:
      context: .
      dockerfile: docker/Dockerfile.ros
    image: microalgas/microros-agent:latest
    container_name: ros_sensor_node
    networks:
      - ros_net
    command: python3 /app/database/ros_sensor_node.py
    depends_on:
      - microros_agent
    restart: unless-stopped
    env_file:
      - database/.env
    environment:
      RMW_IMPLEMENTATION: rmw_fastrtps_cpp
      FASTRTPS_DEFAULT_PROFILES_FILE: /app/config/fastrtps_bridge.xml
    volumes:
      - ./config/fastrtps_bridge.xml:/app/config/fastrtps_bridge.xml:ro
      # Monta el código Python en vivo — cambios se aplican sin rebuild.
      # Solo reiniciar el contenedor: docker compose -f docker-compose.windows.yml restart ros_node
      - ./database:/app/database:ro
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

# ── Red bridge compartida entre los dos servicios ────────────────────────────
networks:
  ros_net:
    driver: bridge
